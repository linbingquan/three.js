<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="../../build/three.js"></script>
    <script src="../../examples/js/controls/OrbitControls.js"></script>
    
    <script src="../../examples/js/libs/inflate.min.js"></script>
    <!-- <script src="../../examples/js/loaders/NRRDLoader.js"></script> -->
    <script src="../../examples/js/curves/NURBSCurve.js"></script>
    <script src="../../examples/js/curves/NURBSUtils.js"></script>
    <script src="../../examples/js/loaders/FBXLoader.js"></script>
    <script src="../../examples/js/objects/Reflector.js"></script>
    <script src="../../examples/js/libs/tween.min.js"></script>
    <script src="./js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <style>
        body { overflow: hidden; margin: 0; padding: 0; }

        .white-bg { padding: 20px; background: rgba(255, 255, 255, 0.6); border-top: 1px solid rgba(0, 0, 0, .125); }
        .gree-prod { margin: 0 auto; padding: 20px; width: 190px; cursor: pointer; }
        .gree-prod:hover { box-shadow: 0 0 20px rgba(0, 0, 0, .125); }
        .gree-prod .prod-img { margin: 0 auto; width: 150px; height: 150px; }
        .gree-prod .prod-txt { text-align: center; text-transform: uppercase; }
    </style>
</head>
<body>
    <script>
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        // var camera = new THREE.OrthographicCamera(window.innerWidth / - 2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / - 2, 1, 1000);

        var control = new THREE.OrbitControls(camera);
        // control.autoRotate = true;
        control.autoRotateSpeed = 1;
        control.enablePan = false;
        control.enableZoom = false;
        control.minPolarAngle = Math.PI / 4; // 垂直高度上方
        control.maxPolarAngle = Math.PI / 2 - 0.01; // 垂直高度下方
        control.minAzimuthAngle = - Math.PI / 4; // radians
	    control.maxAzimuthAngle = Math.PI / 4; // radians

        var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true; // 渲染器开启阴影

        // 挂载节点
        document.body.appendChild(renderer.domElement);

        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2(); // 鼠标移动位置
        var intersectedObj; // 用户选中对象

        var ambientLight = new THREE.AmbientLight( 0xffffff );
        scene.add(ambientLight);

        var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);

        directionalLight.shadow.camera.near = 20; //产生阴影的最近距离
        directionalLight.shadow.camera.far = 1000; //产生阴影的最远距离
        directionalLight.shadow.camera.left = -1000; //产生阴影距离位置的最左边位置
        directionalLight.shadow.camera.right = 1000; //最右边
        directionalLight.shadow.camera.top = 1000; //最上边
        directionalLight.shadow.camera.bottom = -1000; //最下面

        //这两个值决定使用多少像素生成阴影 默认512
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.mapSize.width = 1024;

        //告诉平行光需要开启阴影投射
        directionalLight.castShadow = true;

        directionalLight.position.set(0, 500, 0);
        scene.add( directionalLight );

        var loader = new THREE.FBXLoader();
        loader.load('./models/cxw-200-ccs02.fbx', function (object) {

            // bugfixed
            object.children.forEach(child => {
                if (child.material) {
                    child.material.side = THREE.DoubleSide;
                    child.rotation.x = THREE.Math.degToRad( 90 );
                }
                //设置模型生成阴影并接收阴影
                child.castShadow = true;
                // child.receiveShadow = true;
            });

            object.name = "cxw-200-ccs02";
            object.position.set(0, 70, 0);
            scene.add(object);

        });

        loader.load('./models/cxw-200-ccs01a.fbx', function (object) {

            // bugfixed
            object.children.forEach(child => {
                if (child.material) {
                    child.material.side = THREE.DoubleSide;
                    child.rotation.x = THREE.Math.degToRad( 90 );
                }
                //设置模型生成阴影并接收阴影
                child.castShadow = true;
                // child.receiveShadow = true;
            });

            object.name = "cxw-200-ccs01a";
            object.position.set(140, 70, 0);
            scene.add(object);

        });

        loader.load('./models/xztd105a-01.fbx', function (object) {

            // bugfixed
            object.children.forEach(child => {
                if (child.material) {
                    child.material.side = THREE.DoubleSide;
                }
                //设置模型生成阴影并接收阴影
                child.castShadow = true;
                // child.receiveShadow = true;
            });

            object.name = "xztd105a-01";
            object.position.set(-150, 70, 0);
            object.scale.set(0.2, 0.2, 0.2);
            scene.add(object);

        });

        loader.load('./models/cxw-200-tcd02.fbx', function (object) {

            // bugfixed
            object.children.forEach(child => {
                if (child.material) {
                    child.material.side = THREE.DoubleSide;
                }
                //设置模型生成阴影并接收阴影
                child.castShadow = true;
                // child.receiveShadow = true;
            });

            object.name = "cxw-200-tcd02";
            object.position.set(300, 70, 0);
            object.scale.set(0.5, 0.5, 0.5);
            scene.add(object);

        });

        // 地面
        var geometry = new THREE.PlaneGeometry(1000, 1000);
        var material = new THREE.MeshLambertMaterial({ color: 0xcccccc });
        material.side = THREE.DoubleSide;
        var plane = new THREE.Mesh(geometry, material);
        plane.rotation.x = -Math.PI / 2;
        // plane.position.y = -70;
        plane.receiveShadow = true;
        plane.name = "ground";
        scene.add(plane);

        camera.position.set(0, 90, 400);

        function onDocumentMouseDown( event ) {

            event.preventDefault();

            mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            
            var intersectObjects = [];
            for (let index = 0; index < scene.children.length; index++) {
                const object = scene.children[index];
                if ( object instanceof THREE.Group) {
                    object.children[0].name = object.name;
                    intersectObjects.push(object.children[0]);
                }
            }

            var intersects = raycaster.intersectObjects( intersectObjects );
            var intersected = intersects[0];

            // 处理点击模型事件
            handleSelectObj(intersected);

        }

        document.addEventListener( 'mousedown', onDocumentMouseDown, false );

        function handleSelectObj( intersected ) {
            if (intersected) {
                $("#jsSelectBox").show();
                $("#jsSelectBox").mouseenter(function () {
                    document.removeEventListener( 'mousedown', onDocumentMouseDown, false );
                });
                $("#jsSelectBox").mouseleave(function () {
                    document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                });
                intersectedObj = intersected.object.parent;
                var { x, y, z } = intersectedObj.position;
                camera.lookAt(x, y, z);

                // control.target = intersectedObj.position;

                // var coords = { offsetGlobalCamera: offsetGlobalCamera, widthGlobalCamera: widthGlobalCamera };
                new TWEEN.Tween(control.target)
                    .to({
                        x: intersectedObj.position.x,
                        // y: intersectedObj.position.y,
                        // z: intersectedObj.position.z
                    }, 1000)
                    .onUpdate(function () {
                        control.enableRotate = false;
                    })
                    .onComplete(function () {
                        control.enableRotate = true;
                    })
                    .easing(TWEEN.Easing.Linear.None)
                    .start();

            } else {
                $("#jsSelectBox").hide();
            }
        }

        function handleLoadObj( fbxName ) {

            loader.load('./models/' + fbxName + '.fbx', function (object) {

                object.name = fbxName;
                var { x, y, z } = intersectedObj.position;
                object.position.set(x, y, z);
                scene.add(object);

                scene.remove(intersectedObj); // 删除选中对象
                intersectedObj = object;

            });
        }

        function handleLoad_CXW200CCS02() {

            loader.load('./models/cxw-200-ccs02.fbx', function (object) {

                // bugfixed
                object.children.forEach(child => {
                    if (child.material) {
                        child.material.side = THREE.DoubleSide;
                        child.rotation.x = THREE.Math.degToRad( 90 );
                    }
                    //设置模型生成阴影并接收阴影
                    child.castShadow = true;
                    // child.receiveShadow = true;
                });

                object.name = "cxw-200-ccs02";

                // 复制位置和替换
                copyPositionAndReplace(object);

            });
        }

        function handleLoad_CXW200CCS01A() {

            loader.load('./models/cxw-200-ccs01a.fbx', function (object) {

                // bugfixed
                object.children.forEach(child => {
                    if (child.material) {
                        child.material.side = THREE.DoubleSide;
                        child.rotation.x = THREE.Math.degToRad( 90 );
                    }
                    //设置模型生成阴影并接收阴影
                    child.castShadow = true;
                    // child.receiveShadow = true;
                });

                object.name = "cxw-200-ccs01a";

                // 复制位置和替换
                copyPositionAndReplace(object);

            });
        }

        function handleLoad_CXW200TCD02() {
            
            loader.load('./models/cxw-200-tcd02.fbx', function (object) {

                // bugfixed
                object.children.forEach(child => {
                    if (child.material) {
                        child.material.side = THREE.DoubleSide;
                    }
                    //设置模型生成阴影并接收阴影
                    child.castShadow = true;
                    // child.receiveShadow = true;
                });

                object.name = "cxw-200-tcd02";
                object.scale.set(0.5, 0.5, 0.5);

                // 复制位置和替换
                copyPositionAndReplace(object);

            });
        }

        function handleLoad_XZTD105A01() {
            
            loader.load('./models/xztd105a-01.fbx', function (object) {

                // bugfixed
                object.children.forEach(child => {
                    if (child.material) {
                        child.material.side = THREE.DoubleSide;
                    }
                    //设置模型生成阴影并接收阴影
                    child.castShadow = true;
                    // child.receiveShadow = true;
                });

                object.name = "xztd105a-01";
                object.scale.set(0.2, 0.2, 0.2);

                // 复制位置和替换
                copyPositionAndReplace(object);

            });
        }

        // 复制位置和替换
        function copyPositionAndReplace(object) {
            // 复制位置
            var { x, y, z } = intersectedObj.position;
            object.position.set(x, y, z);
            scene.add(object);

            scene.remove(intersectedObj); // 删除选中对象
            intersectedObj = object;
        }

        // 设置场景背景
        function initSceneBG() {

            var envMap = new THREE.CubeTextureLoader()
                .setPath( '../../examples/textures/cube/skyboxsun25deg/')
                .load( [ 'px.jpg', 'nx.jpg', 'py.jpg', 'ny.jpg', 'pz.jpg', 'nz.jpg' ] );

            scene.background = envMap;

        }

        // 屏幕改变
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.render( scene, camera );
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize, false);

        var animate = function () {
            requestAnimationFrame(animate);
            control.update();
            TWEEN.update();

            renderer.render(scene, camera);
        }
        initSceneBG();
        animate();

        document.addEventListener( 'dragover', function ( event ) {

            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';

        }, false );

        document.addEventListener( 'drop', function ( event ) {

            event.preventDefault();

            console.log( event.dataTransfer.files );

        }, false );
    </script>
    <div id="jsSelectBox" class="fixed-bottom white-bg" style="display: none;">
        <div class="row justity-content-center">
            <div class="col">
                <div class="card gree-prod" onclick="handleLoad_CXW200CCS02()">
                    <img class="prod-img" src="./image/cxw-200-ccs02.png" alt="">
                    <div class="prod-txt">cxw-200-ccs02</div>
                </div>
            </div>
            <div class="col">
                <div class="card gree-prod" onclick="handleLoad_CXW200CCS01A()">
                    <img class="prod-img" src="./image/cxw-200-ccs01a.png" alt="">
                    <div class="prod-txt">cxw-200-ccs01a</div>
                </div>
            </div>
            <div class="col">
                <div class="card gree-prod" onclick="handleLoad_CXW200TCD02()">
                    <img class="prod-img" src="./image/cxw-200-tcd02.png" alt="">
                    <div class="prod-txt">cxw-200-tcd02</div>
                </div>
            </div>
            <div class="col">
                <div class="card gree-prod" onclick="handleLoad_XZTD105A01()">
                    <img class="prod-img" src="./image/xztd105a-01.png" alt="">
                    <div class="prod-txt">xztd105a-01</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>